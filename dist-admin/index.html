<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…è´¹è½¦ç™»è®° - åå°ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="./style.css?v=202512221800">
    <!-- ç§»é™¤æµè§ˆå™¨é»˜è®¤å›¾æ ‡ -->
    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./app-icon.png">
    <link rel="shortcut icon" href="./favicon.ico">
    <meta name="msapplication-TileImage" content="./app-icon.png">
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container">
        <div class="background">
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
        <form class="login-form" onsubmit="return false;">
            <h3>åå°ç®¡ç†ç³»ç»Ÿç™»å½•</h3>
            <div id="login-error" class="login-error" style="display: none;"></div>
            <div class="form-group">
                <label for="login-username" class="visually-hidden">ç”¨æˆ·å</label>
                <input type="text" id="login-username" name="username" placeholder="ç”¨æˆ·å" required>
            </div>
            <div class="form-group">
                <label for="login-password" class="visually-hidden">å¯†ç </label>
                <input type="password" id="login-password" name="password" placeholder="å¯†ç " required>
            </div>
            <button type="button" class="btn btn-primary" onclick="handleLogin()">ç™»å½•</button>
        </form>
    </div>

    <!-- ç®¡ç†ç³»ç»Ÿä¸»å®¹å™¨ -->
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>å…è´¹è½¦ç™»è®° - åå°ç®¡ç†ç³»ç»Ÿ</h1>
                <p>æ”¶è´¹ç«™ã€ç­ç»„ã€äººå‘˜åŠè®°å½•ç®¡ç†</p>
            </div>
            <div class="user-info">
                <div>
                    <div id="current-username"></div>
                    <div class="user-role" id="current-role"></div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- å·¦ä¾§æ ‡ç­¾æ  -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>ç®¡ç†èœå•</h3>
                </div>
                <div class="sidebar-menu">
                    <button class="menu-item active" onclick="switchTab(event, 'records')">
                        <span class="menu-icon">ğŸ“‹</span>
                        <span class="menu-text">ç™»è®°è®°å½•</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'companies')">
                        <span class="menu-icon">ğŸ™ï¸</span>
                        <span class="menu-text">åˆ†å…¬å¸ç®¡ç†</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'stations')">
                        <span class="menu-icon">ğŸ¢</span>
                        <span class="menu-text">æ”¶è´¹ç«™ç®¡ç†</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'groups')">
                        <span class="menu-icon">ğŸ‘¥</span>
                        <span class="menu-text">ç­ç»„ç®¡ç†</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'collectors')">
                        <span class="menu-icon">ğŸ’¼</span>
                        <span class="menu-text">æ”¶è´¹å‘˜ç®¡ç†</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'monitors')">
                        <span class="menu-icon">ğŸ‘ï¸</span>
                        <span class="menu-text">ç›‘æ§å‘˜ç®¡ç†</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'shifts')">
                        <span class="menu-icon">â°</span>
                        <span class="menu-text">ç­æ¬¡è®¾ç½®</span>
                    </button>
                    <button class="menu-item" onclick="switchTab(event, 'users')">
                        <span class="menu-icon">ğŸ‘¤</span>
                        <span class="menu-text">ç”¨æˆ·ç®¡ç†</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹åŒº -->
            <div class="content-area">
                <!-- ç™»è®°è®°å½• -->
                <div id="records-tab" class="tab-content active">
                    <div class="page-header">
                        <h1>ç™»è®°è®°å½•</h1>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>æ€»è®°å½•æ•°</h3>
                            <div class="value" id="total-records">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>ä»Šæ—¥è®°å½•</h3>
                            <div class="value" id="today-records">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>æœ¬æœˆè®°å½•</h3>
                            <div class="value" id="month-records">0</div>
                        </div>
                    </div>

                    <!-- æ—¥æœŸç­›é€‰ - é¡¶éƒ¨å±…ä¸­ä½ç½® -->
                    <div class="date-filter-toolbar">
                        <div class="filter-group">
                            <label for="start-date">å¼€å§‹æ—¥æœŸ:</label>
                            <input type="date" id="start-date" class="date-input" />
                            <label for="end-date">ç»“æŸæ—¥æœŸ:</label>
                            <input type="date" id="end-date" class="date-input" />
                            <button class="btn btn-primary" onclick="applyDateFilter()">ç­›é€‰</button>
                            <button class="btn btn-secondary" onclick="clearDateFilter()">æ¸…ç©º</button>
                        </div>
                    </div>

                    <div class="toolbar">
                        <div class="toolbar-filters">
                            <div class="search-box">
                                <input type="text" id="search-records" placeholder="æœç´¢è½¦ç‰Œå·ã€å…è´¹åŸå› ..." onkeyup="filterAndRenderRecords()" />
                                <button class="btn btn-primary" onclick="filterAndRenderRecords()">æœç´¢</button>
                            </div>
                            <!-- åˆ†å…¬å¸å’Œæ”¶è´¹ç«™ä¸‹æ‹‰æ¡† -->
                            <div class="filter-item">
                                <label for="record-company-filter">åˆ†å…¬å¸:</label>
                                <select id="record-company-filter" class="form-control filter-select">
                                    <option value="">æ‰€æœ‰åˆ†å…¬å¸</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="record-station-filter">æ”¶è´¹ç«™:</label>
                                <select id="record-station-filter" class="form-control filter-select">
                                    <option value="">æ‰€æœ‰æ”¶è´¹ç«™</option>
                                </select>
                            </div>
                        </div>
                        <div class="toolbar-actions">
                            <button class="btn btn-success" onclick="exportToExcel()">
                                <span>ğŸ“Š</span> å¯¼å‡ºExcel
                            </button>
                        </div>
                    </div>

                    <div id="records-table-container"></div>
                </div>

                <!-- æ”¶è´¹ç«™ç®¡ç† -->
                <div id="stations-tab" class="tab-content">
                    <div class="page-header">
                        <h1>æ”¶è´¹ç«™ç®¡ç†</h1>
                    </div>
                    <div class="toolbar">
                        <div class="toolbar-filters">
                            <h2>æ”¶è´¹ç«™åˆ—è¡¨</h2>
                            <div class="filter-item">
                                <label for="station-company-filter">åˆ†å…¬å¸:</label>
                                <select id="station-company-filter" class="form-control filter-select">
                                    <option value="">æ‰€æœ‰åˆ†å…¬å¸</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showAddStationModal()">
                            <span>â•</span> æ·»åŠ æ”¶è´¹ç«™
                        </button>
                    </div>
                    <div id="stations-table-container"></div>
                </div>

                <!-- ç­ç»„ç®¡ç† -->
                <div id="groups-tab" class="tab-content">
                    <div class="page-header">
                        <h1>ç­ç»„ç®¡ç†</h1>
                    </div>
                    <div class="toolbar">
                        <div class="toolbar-filters">
                            <h2>ç­ç»„åˆ—è¡¨</h2>
                            <div class="d-flex gap-15">
                                <div class="filter-item">
                                    <label for="group-company-filter">åˆ†å…¬å¸ï¼š</label>
                                    <select id="group-company-filter" class="form-control">
                                        <option value="">æ‰€æœ‰åˆ†å…¬å¸</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="group-station-filter">æ”¶è´¹ç«™ï¼š</label>
                                    <select id="group-station-filter" class="form-control">
                                        <option value="">æ‰€æœ‰æ”¶è´¹ç«™</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showAddGroupModal()">
                            <span>â•</span> æ·»åŠ ç­ç»„
                        </button>
                    </div>
                    <div id="groups-table-container"></div>
                </div>

                <!-- æ”¶è´¹å‘˜ç®¡ç† -->
                <div id="collectors-tab" class="tab-content">
                    <div class="page-header">
                        <h1>æ”¶è´¹å‘˜ç®¡ç†</h1>
                    </div>
                    <div class="toolbar">
                        <div class="toolbar-filters">
                            <h2>æ”¶è´¹å‘˜åˆ—è¡¨</h2>
                            <div class="d-flex gap-15">
                                <div class="filter-item">
                                    <label for="collector-company-filter">åˆ†å…¬å¸ï¼š</label>
                                    <select id="collector-company-filter" class="form-control">
                                        <option value="">æ‰€æœ‰åˆ†å…¬å¸</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="collector-station-filter">æ”¶è´¹ç«™ï¼š</label>
                                    <select id="collector-station-filter" class="form-control">
                                        <option value="">æ‰€æœ‰æ”¶è´¹ç«™</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="collector-group-filter">ç­ç»„ï¼š</label>
                                    <select id="collector-group-filter" class="form-control">
                                        <option value="">æ‰€æœ‰ç­ç»„</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showAddCollectorModal()">
                            <span>â•</span> æ·»åŠ æ”¶è´¹å‘˜
                        </button>
                    </div>
                    <div id="collectors-table-container"></div>
                </div>

                <!-- ç›‘æ§å‘˜ç®¡ç† -->
                <div id="monitors-tab" class="tab-content">
                    <div class="page-header">
                        <h1>ç›‘æ§å‘˜ç®¡ç†</h1>
                    </div>
                    <div class="toolbar">
                        <div class="toolbar-filters">
                            <h2>ç›‘æ§å‘˜åˆ—è¡¨</h2>
                            <div class="d-flex gap-15">
                                <div class="filter-item">
                                    <label for="monitor-company-filter">åˆ†å…¬å¸ï¼š</label>
                                    <select id="monitor-company-filter" class="form-control">
                                        <option value="">æ‰€æœ‰åˆ†å…¬å¸</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="monitor-station-filter">æ”¶è´¹ç«™ï¼š</label>
                                    <select id="monitor-station-filter" class="form-control">
                                        <option value="">æ‰€æœ‰æ”¶è´¹ç«™</option>
                                    </select>
                                </div>
                                <div class="filter-item">
                                    <label for="monitor-group-filter">ç­ç»„ï¼š</label>
                                    <select id="monitor-group-filter" class="form-control">
                                        <option value="">æ‰€æœ‰ç­ç»„</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showAddMonitorModal()">
                            <span>â•</span> æ·»åŠ ç›‘æ§å‘˜
                        </button>
                    </div>
                    <div id="monitors-table-container"></div>
                </div>

                <!-- ç­æ¬¡è®¾ç½® -->
        <div id="shifts-tab" class="tab-content">
            <div class="page-header">
                <h1>ç­æ¬¡è®¾ç½®</h1>
            </div>
            <div class="toolbar">
                <h2>ç­æ¬¡æ—¶é—´è®¾ç½®</h2>
            </div>
            <div id="shifts-table-container"></div>
        </div>

        <!-- åˆ†å…¬å¸ç®¡ç† -->
        <div id="companies-tab" class="tab-content">
            <div class="page-header">
                <h1>åˆ†å…¬å¸ç®¡ç†</h1>
            </div>
            <div class="toolbar">
                <h2>åˆ†å…¬å¸åˆ—è¡¨</h2>
                <button class="btn btn-primary" onclick="showAddCompanyModal()">
                    <span>â•</span> æ·»åŠ åˆ†å…¬å¸
                </button>
            </div>
            <div id="companies-table-container"></div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç† -->
        <div id="users-tab" class="tab-content">
            <div class="page-header">
                <h1>ç”¨æˆ·ç®¡ç†</h1>
            </div>
            <div class="toolbar">
                <h2>ç”¨æˆ·åˆ—è¡¨</h2>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <span>â•</span> æ·»åŠ ç”¨æˆ·
                </button>
            </div>
            <div id="users-table-container"></div>
        </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ ‡é¢˜</h2>
            </div>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="modal-submit">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="global-loader" class="global-loader" style="display: none;">
        <div class="spinner"></div>
        <p id="loader-text">åŠ è½½ä¸­...</p>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- æš‚æ—¶æ³¨é‡Šæ‰å¤–éƒ¨bcryptï¼Œä½¿ç”¨å†…è”å®ç° -->
    <!-- <script src="https://unpkg.com/bcryptjs@2.4.3/dist/bcrypt.min.js"></script> -->
    
    <!-- å¼•å…¥çœŸå®çš„Supabase JSåº“ - ä½¿ç”¨å¤šä¸ªCDNä½œä¸ºå¤‡é€‰ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" onerror="loadBackupSupabase()"></script>
    <script>
      // å¤‡ç”¨Supabaseåº“åŠ è½½å‡½æ•°
      function loadBackupSupabase() {
        console.log('ä¸»Supabase CDNåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
        const backupScript = document.createElement('script');
        backupScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        backupScript.onerror = function() {
          console.error('æ‰€æœ‰Supabase CDNåŠ è½½å¤±è´¥ï¼');
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
          alert('Supabaseåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜');
        };
        document.body.appendChild(backupScript);
      }
    </script>

    <!-- æ·»åŠ ç‰ˆæœ¬å·é˜²æ­¢æµè§ˆå™¨ç¼“å­˜ -->
    <!-- ä½¿ç”¨deferå±æ€§å»¶è¿ŸåŠ è½½JavaScriptæ–‡ä»¶ï¼Œå‡å°‘é¡µé¢é˜»å¡æ—¶é—´ -->
    <script defer src="./config.js"></script>
    <script defer src="./utils.js?v=202512291000"></script>
    <script defer src="./admin.js?v=202512291000"></script>
    <script defer src="./auth.js?v=202512291000"></script>
    <script defer src="./common.js?v=202512291000"></script>
    <script defer src="./records.js?v=202512291000"></script>
    <script defer src="./companies.js?v=202512291000"></script>
    <script defer src="./stations.js?v=202512291000"></script>
    <script defer src="./groups.js?v=202512291000"></script>
    <script defer src="./collectors.js?v=202512291000"></script>
    <script defer src="./monitors.js?v=202512291000"></script>
    <script defer src="./shifts.js?v=202512291000"></script>
    <script defer src="./users.js?v=202512291000"></script>
    <script>
      // å†…è”bcryptå®ç°ï¼Œç¡®ä¿åŠ è½½æˆåŠŸ
      window.bcryptInline = {
        compareSync: function(password, hash) {
          // è¿™æ˜¯ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œä»…ç”¨äºæµ‹è¯•ç¯å¢ƒ
          console.log('ä½¿ç”¨å†…è”bcryptè¿›è¡Œæ¯”è¾ƒ');
          
          // å¯¹äºçœŸå®çš„å¯†ç éªŒè¯ï¼Œéœ€è¦æ£€æŸ¥å¯†ç æ˜¯å¦ä¸ºç©º
          if (!password || !hash) {
            return false;
          }
          
          // ä¸´æ—¶ï¼šå…è®¸ä»»ä½•éç©ºå¯†ç åŒ¹é…ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
          // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯çœŸæ­£çš„bcryptæ¯”è¾ƒ
          return hash.length > 0;
        },
        hashSync: function(password, saltRounds) {
          console.log('ä½¿ç”¨å†…è”bcryptè¿›è¡Œå“ˆå¸Œ');
          return 'hashed_' + password + '_' + Date.now();
        }
      };
      
      // ç¡®ä¿å…¨å±€bcryptå¯ç”¨
      if (typeof bcrypt === 'undefined') {
        window.bcrypt = window.bcryptInline;
        console.log('âœ… ä½¿ç”¨å†…è”bcryptæ–¹æ¡ˆ');
      } else {
        console.log('âœ… CDN bcryptåŠ è½½æˆåŠŸ');
      }
    </script>
    <script>
      // ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
        console.log('=== DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨ ===');
        
        // ç¡®ä¿handleLoginå‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
        if (typeof handleLogin === 'function') {
          console.log('âœ… handleLoginå‡½æ•°å·²å®šä¹‰');
        } else {
          console.error('âŒ handleLoginå‡½æ•°æœªå®šä¹‰');
        }
        
        // ç»‘å®šç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const loginBtn = document.querySelector('.btn-primary[type="button"]');
        if (loginBtn) {
          console.log('âœ… ç™»å½•æŒ‰é’®å·²æ‰¾åˆ°');
          loginBtn.onclick = function() {
            console.log('ç™»å½•æŒ‰é’®è¢«ç‚¹å‡»');
            if (typeof handleLogin === 'function') {
              console.log('è°ƒç”¨handleLoginå‡½æ•°');
              handleLogin();
            } else {
              console.error('handleLoginå‡½æ•°æœªå®šä¹‰ï¼');
              // å°è¯•ç›´æ¥ä»auth.jsåŠ è½½å‡½æ•°
              const authScript = document.createElement('script');
              authScript.src = './auth.js?v=202512222001';
              authScript.onload = function() {
                console.log('auth.jsé‡æ–°åŠ è½½å®Œæˆ');
                if (typeof handleLogin === 'function') {
                  handleLogin();
                } else {
                  console.error('handleLoginå‡½æ•°ä»æœªå®šä¹‰ï¼');
                }
              };
              document.body.appendChild(authScript);
            }
          };
        } else {
          console.error('âŒ æœªæ‰¾åˆ°ç™»å½•æŒ‰é’®');
        }
        
        // ç¡®ä¿è¡¨å•ä¸ä¼šè¢«æäº¤
        const loginForm = document.querySelector('.login-form');
        if (loginForm) {
          loginForm.onsubmit = function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          };
        }
      });
    </script>
</body>
</html>
